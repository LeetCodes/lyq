<html>
<head>
<script type="text/javascript" src="lib/jquery.js"/>
<script>
Configs = {
	defaultConfigs: {
		bitly_login : 'kentaro',
		bitly_apiKey : 'R_3af5ffa1b78539a1d3df3c2a16edfb21',
		username : 'kentaro.fukuchi@gmail.com',
		password : 'gN8Makds'
	},
	save: function(configs) {
		localStorage['configs'] = JSON.stringfy(configs);
	},
	load: function(forceDefault) {
		var configs = $.extend(true, {}, this.defaultConfigs);
		if (forceDefault) {
			return configs;
		}
		try {
			var stored = JSON.parse(localStorage['configs']);
			if (stored) {
				$.extend(true, configs, stored);
			}
		} catch (e) { }
		return configs;
	},
	lyq: localStorage['mode'],
	setLyq: function(mode) {
		localStorage['mode'] = mode;
		this.lyqmode = mode;
	}
}

function shortenURI(uri) {
	var options = Configs.load();
	var xhr = new XMLHttpRequest();
	var param = {"login": options['bitly_login'],
				 "apiKey": options['bitly_apiKey'],
				 "version": "2.0.1",
				 "longUrl": encodeURIComponent(uri)};
	var pairs = new Array();

	for (var key in param) {
		pairs.push(key + '=' + param[key]);
	}
	xhr.open("GET", "http://api.bit.ly/shorten?" + pairs.join('&'), false);
	xhr.send(null);
	if (xhr.status == 200) {
		var res = JSON.parse(xhr.responseText);
		var entry;
		for (var key in res.results) {
			entry = res.results[key];
			break;
		}
		return entry.shortUrl;
	}
	return null;
}

function tweet(msg, uri) {
	var options = Configs.load();
	var length = decodeURI(msg).length;
	if (uri && length < (140 - 22)) {
		msg += ' ' + shortenURI(uri);
	}

	var xhr = new XMLHttpRequest();
	xhr.open("POST", "http://twitter.com/statuses/update.json", false, options['username'], options['password']);
	xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
	xhr.send("status=" + msg);
}

chrome.extension.onRequest.addListener(function(req, sender, resp) {
	tweet(req.message, req.uri);
});
</script>
</head>
</html>
